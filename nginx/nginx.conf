# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    include mime.types;
    default_type application/octet-stream;
    sendfile on;
    keepalive_timeout 65;

    server {
        listen 80; # Listen on port 80 inside Docker Network

        # **ใหม่:** Location สำหรับ Admin API Endpoint
        location /api/admin/ {
            # **สำคัญ:** จำกัดการเข้าถึงเฉพาะ IP ที่อนุญาต
            # ตัวอย่าง: อนุญาตให้เข้าถึงจาก IP Range ของ Docker Default Bridge Network (172.17.0.0/16)
            # คุณอาจจะต้องปรับ IP Range นี้ให้ตรงกับ Docker Network ของคุณจริงๆ ถ้าไม่ได้ใช้ Default
            allow 172.17.0.0/16; # อนุญาตจาก IP Range นี้
            # allow 172.18.0.0/16; # ถ้าใช้ Custom Bridge Network ที่ IP Range นี้

            # หรือถ้าคุณทราบ IP ภายในของ Host ใน Docker Network ที่แน่นอน
            # allow 172.17.0.1; # ตัวอย่าง IP ของ Gateway หรือ Host ในบาง config

            deny all; # ปฏิเสธทุก IP อื่นๆ ที่ไม่ได้อยู่ใน allow list

            # Proxy requests to backend service
            proxy_pass http://backend:8000; # Proxy ไปยัง Backend Container บน Port 8000

            # Headers for backend
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme; # Important to know original scheme (HTTPS from Cloudflare)
        }

        # Location สำหรับ API Endpoints อื่นๆ ทั่วไป (เช่น /api/generate_qr)
        # ต้องอยู่หลังจาก location /api/admin/ เพื่อให้ Nginx match /api/admin/ ก่อน
        location /api/ {
            # ที่นี่ ไม่ต้องมี allow/deny เพราะเราต้องการให้เข้าถึงได้จาก Cloudflare Tunnel (ซึ่งก็คือมาจาก IP ภายใน Docker Network)
            # Authentication (API Key) จะทำใน Backend แทน

            proxy_pass http://backend:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Location สำหรับ Frontend Static Files
        location / {
            # Serve static files from the mounted volume
            root /usr/share/nginx/html; # Path ที่ mount static files จาก SolidStart build
            index index.html index.htm;
            try_files $uri $uri/ /index.html; # สำหรับ SPA routing
        }
    }
}